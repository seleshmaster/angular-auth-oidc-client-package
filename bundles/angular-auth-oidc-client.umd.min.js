!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/common"),require("jsrsasign"),require("@angular/common/http"),require("@angular/router"),require("rxjs"),require("@angular/core"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("angular-auth-oidc-client",["exports","@angular/common","jsrsasign","@angular/common/http","@angular/router","rxjs","@angular/core","rxjs/operators"],t):t(e["angular-auth-oidc-client"]={},e.ng.common,e.jsrsasign,e.ng.common.http,e.ng.router,e.rxjs,e.ng.core,e.rxjs.operators)}(this,function(e,t,w,h,i,p,o,f){"use strict";var r=function(){function e(){this.issuer="",this.jwks_uri="",this.authorization_endpoint="",this.token_endpoint="",this.userinfo_endpoint="",this.end_session_endpoint="",this.check_session_iframe="",this.revocation_endpoint="",this.introspection_endpoint=""}return e.prototype.setWellKnownEndpoints=function(e){this.issuer=e.issuer,this.jwks_uri=e.jwks_uri,this.authorization_endpoint=e.authorization_endpoint,this.token_endpoint=e.token_endpoint,this.userinfo_endpoint=e.userinfo_endpoint,e.end_session_endpoint&&(this.end_session_endpoint=e.end_session_endpoint),e.check_session_iframe&&(this.check_session_iframe=e.check_session_iframe),e.revocation_endpoint&&(this.revocation_endpoint=e.revocation_endpoint),e.introspection_endpoint&&(this.introspection_endpoint=e.introspection_endpoint)},e}(),s=function x(e,t){this.authorizationState=e,this.validationResult=t},a={authorized:"authorized",forbidden:"forbidden",unauthorized:"unauthorized"},n=function K(){this.keys=[]},u=function V(){this.kty="",this.use="",this.kid="",this.x5t="",this.e="",this.n="",this.x5c=[]},c={NotSet:"NotSet",StatesDoNotMatch:"StatesDoNotMatch",SignatureFailed:"SignatureFailed",IncorrectNonce:"IncorrectNonce",RequiredPropertyMissing:"RequiredPropertyMissing",MaxOffsetExpired:"MaxOffsetExpired",IssDoesNotMatchIssuer:"IssDoesNotMatchIssuer",NoAuthWellKnownEndPoints:"NoAuthWellKnownEndPoints",IncorrectAud:"IncorrectAud",TokenExpired:"TokenExpired",IncorrectAtHash:"IncorrectAtHash",Ok:"Ok",LoginRequired:"LoginRequired",SecureTokenServerError:"SecureTokenServerError"},l=function U(e,t,i,o,n){void 0===e&&(e=""),void 0===t&&(t=""),void 0===i&&(i=!1),void 0===o&&(o={}),void 0===n&&(n=c.NotSet),this.access_token=e,this.id_token=t,this.authResponseIsValid=i,this.decoded_id_token=o,this.state=n},d=function H(){this.stsServer="https://localhost:44318",this.redirect_url="https://localhost:44311",this.client_id="angularclient",this.response_type="id_token token",this.scope="openid email profile",this.hd_param="",this.post_logout_redirect_uri="https://localhost:44311/unauthorized",this.start_checksession=!1,this.silent_renew=!1,this.silent_renew_url="https://localhost:44311",this.silent_renew_offset_in_seconds=0,this.silent_redirect_url="https://localhost:44311",this.post_login_route="/",this.forbidden_route="/forbidden",this.unauthorized_route="/unauthorized",this.auto_userinfo=!0,this.auto_clean_state_after_authentication=!0,this.trigger_authorization_result_event=!1,this.log_console_warning_active=!0,this.log_console_debug_active=!1,this.iss_validation_off=!1,this.history_cleanup_off=!1,this.max_id_token_iat_offset_allowed_in_seconds=3,this.disable_iat_offset_validation=!1,this.storage="undefined"!=typeof Storage?sessionStorage:null},g=function(){function e(e){this.platformId=e,this._onConfigurationChange=new p.Subject,this.defaultConfig=new d}return Object.defineProperty(e.prototype,"stsServer",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.stsServer:this.defaultConfig.stsServer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"redirect_url",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.redirect_url:this.defaultConfig.redirect_url},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"silent_redirect_url",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.silent_renew_url:this.defaultConfig.silent_renew_url},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"client_id",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.client_id:this.defaultConfig.client_id},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"response_type",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.response_type:this.defaultConfig.response_type},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scope",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.scope:this.defaultConfig.scope},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hd_param",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.hd_param:this.defaultConfig.hd_param},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"post_logout_redirect_uri",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.post_logout_redirect_uri:this.defaultConfig.post_logout_redirect_uri},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"start_checksession",{get:function(){return!!t.isPlatformBrowser(this.platformId)&&(this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.start_checksession:this.defaultConfig.start_checksession)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"silent_renew",{get:function(){return!!t.isPlatformBrowser(this.platformId)&&(this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.silent_renew:this.defaultConfig.silent_renew)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"silent_renew_offset_in_seconds",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.silent_renew_offset_in_seconds:this.defaultConfig.silent_renew_offset_in_seconds},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"post_login_route",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.post_login_route:this.defaultConfig.post_login_route},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"forbidden_route",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.forbidden_route:this.defaultConfig.forbidden_route},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"unauthorized_route",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.unauthorized_route:this.defaultConfig.unauthorized_route},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"auto_userinfo",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.auto_userinfo:this.defaultConfig.auto_userinfo},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"auto_clean_state_after_authentication",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.auto_clean_state_after_authentication:this.defaultConfig.auto_clean_state_after_authentication},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"trigger_authorization_result_event",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.trigger_authorization_result_event:this.defaultConfig.trigger_authorization_result_event},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isLogLevelWarningEnabled",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.log_console_warning_active:this.defaultConfig.log_console_warning_active},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isLogLevelDebugEnabled",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.log_console_debug_active:this.defaultConfig.log_console_debug_active},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"iss_validation_off",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.iss_validation_off:this.defaultConfig.iss_validation_off},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"history_cleanup_off",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.history_cleanup_off:this.defaultConfig.history_cleanup_off},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"max_id_token_iat_offset_allowed_in_seconds",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.max_id_token_iat_offset_allowed_in_seconds:this.defaultConfig.max_id_token_iat_offset_allowed_in_seconds},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"disable_iat_offset_validation",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.disable_iat_offset_validation:this.defaultConfig.disable_iat_offset_validation},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"storage",{get:function(){return this.openIDImplicitFlowConfiguration?this.openIDImplicitFlowConfiguration.storage:this.defaultConfig.storage},enumerable:!0,configurable:!0}),e.prototype.init=function(e){this.openIDImplicitFlowConfiguration=e,this._onConfigurationChange.next(e)},Object.defineProperty(e.prototype,"onConfigurationChange",{get:function(){return this._onConfigurationChange.asObservable()},enumerable:!0,configurable:!0}),e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:Object,decorators:[{type:o.Inject,args:[o.PLATFORM_ID]}]}]},e}(),_=function(){function e(e){this.httpClient=e}return e.prototype.getWellknownEndpoints=function(e){var t=new h.HttpHeaders;return t=t.set("Accept","application/json"),this.httpClient.get(e,{headers:t})},e.prototype.getIdentityUserData=function(e,t){var i=new h.HttpHeaders;return i=(i=i.set("Accept","application/json")).set("Authorization","Bearer "+decodeURIComponent(t)),this.httpClient.get(e,{headers:i})},e.prototype.get=function(e){var t=new h.HttpHeaders;return t=t.set("Accept","application/json"),this.httpClient.get(e,{headers:t})},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:h.HttpClient}]},e}(),y=function(){function e(e){this.authConfiguration=e}return e.prototype.logError=function(e){console.error(e)},e.prototype.logWarning=function(e){this.authConfiguration.isLogLevelWarningEnabled&&console.warn(e)},e.prototype.logDebug=function(e){this.authConfiguration.isLogLevelDebugEnabled&&console.log(e)},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:g}]},e}(),S=function(){function e(e){this.loggerService=e}return e.prototype.getExistingIFrame=function(e){var t=this.getIFrameFromParentWindow(e);return t||this.getIFrameFromWindow(e)},e.prototype.addIFrameToWindowBody=function(e){var t=window.document.createElement("iframe");return t.id=e,this.loggerService.logDebug(t),t.style.display="none",window.document.body.appendChild(t),t},e.prototype.getIFrameFromParentWindow=function(e){return window.parent.document.getElementById(e)},e.prototype.getIFrameFromWindow=function(e){return window.document.getElementById(e)},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:y}]},e}(),v=function(){function e(){}return e.prototype.areEqual=function(e,t){if(!e||!t)return!1;if(this.bothValuesAreArrays(e,t))return this.arraysEqual(e,t);if(this.bothValuesAreStrings(e,t))return e===t;if(this.bothValuesAreObjects(e,t))return JSON.stringify(e).toLowerCase()===JSON.stringify(t).toLowerCase();if(this.oneValueIsStringAndTheOtherIsArray(e,t)){if(Array.isArray(e)&&this.valueIsString(t))return e[0]===t;if(Array.isArray(t)&&this.valueIsString(e))return t[0]===e}},e.prototype.oneValueIsStringAndTheOtherIsArray=function(e,t){return Array.isArray(e)&&this.valueIsString(t)||Array.isArray(t)&&this.valueIsString(e)},e.prototype.bothValuesAreObjects=function(e,t){return this.valueIsObject(e)&&this.valueIsObject(t)},e.prototype.bothValuesAreStrings=function(e,t){return this.valueIsString(e)&&this.valueIsString(t)},e.prototype.bothValuesAreArrays=function(e,t){return Array.isArray(e)&&Array.isArray(t)},e.prototype.valueIsString=function(e){return"string"==typeof e||e instanceof String},e.prototype.valueIsObject=function(e){return"object"==typeof e},e.prototype.arraysEqual=function(e,t){if(e.length!==t.length)return!1;for(var i=e.length;i--;)if(e[i]!==t[i])return!1;return!0},e.decorators=[{type:o.Injectable}],e}(),m=function(){function e(e){this.loggerService=e,this.PARTS_OF_TOKEN=3}return e.prototype.getTokenExpirationDate=function(e){if(!e.hasOwnProperty("exp"))return new Date;var t=new Date(0);return t.setUTCSeconds(e.exp),t},e.prototype.getHeaderFromToken=function(e,t){return this.tokenIsValid(e)?this.getPartOfToken(e,0,t):{}},e.prototype.getPayloadFromToken=function(e,t){return this.tokenIsValid(e)?this.getPartOfToken(e,1,t):{}},e.prototype.getSignatureFromToken=function(e,t){return this.tokenIsValid(e)?this.getPartOfToken(e,2,t):{}},e.prototype.getPartOfToken=function(e,t,i){var o=this.extractPartOfToken(e,t);if(i)return o;var n=this.urlBase64Decode(o);return JSON.parse(n)},e.prototype.urlBase64Decode=function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw Error("Illegal base64url string!")}var i="undefined"!=typeof window?window.atob(t):new Buffer(t,"base64").toString("binary");try{return decodeURIComponent(i.split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}catch(o){return i}},e.prototype.tokenIsValid=function(e){return e?e.includes(".")?e.split(".").length===this.PARTS_OF_TOKEN||(this.loggerService.logError("token '"+e+"' is not valid --\x3e token has t have exact three dots"),!1):(this.loggerService.logError("token '"+e+"' is not valid --\x3e no dots included"),!1):(this.loggerService.logError("token '"+e+"' is not valid --\x3e token falsy"),!1)},e.prototype.extractPartOfToken=function(e,t){return e.split(".")[t]},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:y}]},e}(),b=function(){function e(){}return e.decorators=[{type:o.Injectable}],e}(),C=function(){function e(e){this.authConfiguration=e,this.hasStorage="undefined"!=typeof Storage}return e.prototype.read=function(e){if(this.hasStorage)return JSON.parse(this.authConfiguration.storage.getItem(e+"_"+this.authConfiguration.client_id))},e.prototype.write=function(e,t){this.hasStorage&&(t=t===undefined?null:t,this.authConfiguration.storage.setItem(e+"_"+this.authConfiguration.client_id,JSON.stringify(t)))},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:g}]},e}(),k=function(){function e(e){this.oidcSecurityStorage=e,this.storage_auth_result="authorizationResult",this.storage_access_token="authorizationData",this.storage_id_token="authorizationDataIdToken",this.storage_is_authorized="_isAuthorized",this.storage_user_data="userData",this.storage_auth_nonce="authNonce",this.storage_code_verifier="code_verifier",this.storage_auth_state_control="authStateControl",this.storage_session_state="session_state",this.storage_silent_renew_running="storage_silent_renew_running",this.storage_custom_request_params="storage_custom_request_params"}return Object.defineProperty(e.prototype,"authResult",{get:function(){return this.retrieve(this.storage_auth_result)},set:function(e){this.store(this.storage_auth_result,e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"accessToken",{get:function(){return this.retrieve(this.storage_access_token)||""},set:function(e){this.store(this.storage_access_token,e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"idToken",{get:function(){return this.retrieve(this.storage_id_token)||""},set:function(e){this.store(this.storage_id_token,e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isAuthorized",{get:function(){return this.retrieve(this.storage_is_authorized)},set:function(e){this.store(this.storage_is_authorized,e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"userData",{get:function(){return this.retrieve(this.storage_user_data)},set:function(e){this.store(this.storage_user_data,e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"authNonce",{get:function(){return this.retrieve(this.storage_auth_nonce)||""},set:function(e){this.store(this.storage_auth_nonce,e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"code_verifier",{get:function(){return this.retrieve(this.storage_code_verifier)||""},set:function(e){this.store(this.storage_code_verifier,e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"authStateControl",{get:function(){return this.retrieve(this.storage_auth_state_control)||""},set:function(e){this.store(this.storage_auth_state_control,e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sessionState",{get:function(){return this.retrieve(this.storage_session_state)},set:function(e){this.store(this.storage_session_state,e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"silentRenewRunning",{get:function(){return this.retrieve(this.storage_silent_renew_running)||""},set:function(e){this.store(this.storage_silent_renew_running,e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"customRequestParams",{get:function(){return this.retrieve(this.storage_custom_request_params)},set:function(e){this.store(this.storage_custom_request_params,e)},enumerable:!0,configurable:!0}),e.prototype.retrieve=function(e){return this.oidcSecurityStorage.read(e)},e.prototype.store=function(e,t){this.oidcSecurityStorage.write(e,t)},e.prototype.resetStorageData=function(e){e||(this.store(this.storage_auth_result,""),this.store(this.storage_session_state,""),this.store(this.storage_silent_renew_running,""),this.store(this.storage_is_authorized,!1),this.store(this.storage_access_token,""),this.store(this.storage_id_token,""),this.store(this.storage_user_data,""),this.store(this.storage_code_verifier,""))},e.prototype.getAccessToken=function(){return this.retrieve(this.storage_access_token)},e.prototype.getIdToken=function(){return this.retrieve(this.storage_id_token)},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:b}]},e}();function I(e){var t="function"==typeof Symbol&&e[Symbol.iterator],i=0;return t?t.call(e):{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}}}var D=function(){function e(e,t,i){this.arrayHelperService=e,this.tokenHelperService=t,this.loggerService=i}return e.prototype.isTokenExpired=function(e,t){var i;return i=this.tokenHelperService.getPayloadFromToken(e,!1),!this.validate_id_token_exp_not_expired(i,t)},e.prototype.validate_id_token_exp_not_expired=function(e,t){var i=this.tokenHelperService.getTokenExpirationDate(e);if(t=t||0,!i)return!1;var o=i.valueOf(),n=(new Date).valueOf()+1e3*t,r=n<o;return this.loggerService.logDebug("Token not expired?: "+o+" > "+n+"  ("+r+")"),r},e.prototype.validate_required_id_token=function(e){var t=!0;return e.hasOwnProperty("iss")||(t=!1,this.loggerService.logWarning("iss is missing, this is required in the id_token")),e.hasOwnProperty("sub")||(t=!1,this.loggerService.logWarning("sub is missing, this is required in the id_token")),e.hasOwnProperty("aud")||(t=!1,this.loggerService.logWarning("aud is missing, this is required in the id_token")),e.hasOwnProperty("exp")||(t=!1,this.loggerService.logWarning("exp is missing, this is required in the id_token")),e.hasOwnProperty("iat")||(t=!1,this.loggerService.logWarning("iat is missing, this is required in the id_token")),t},e.prototype.validate_id_token_iat_max_offset=function(e,t,i){if(i)return!0;if(!e.hasOwnProperty("iat"))return!1;var o=new Date(0);return o.setUTCSeconds(e.iat),t=t||0,null!=o&&(this.loggerService.logDebug("validate_id_token_iat_max_offset: "+((new Date).valueOf()-o.valueOf())+" < "+1e3*t),(new Date).valueOf()-o.valueOf()<1e3*t)},e.prototype.validate_id_token_nonce=function(e,t){return e.nonce===t||(this.loggerService.logDebug("Validate_id_token_nonce failed, dataIdToken.nonce: "+e.nonce+" local_nonce:"+t),!1)},e.prototype.validate_id_token_iss=function(e,t){return e.iss===t||(this.loggerService.logDebug("Validate_id_token_iss failed, dataIdToken.iss: "+e.iss+" authWellKnownEndpoints issuer:"+t),!1)},e.prototype.validate_id_token_aud=function(e,t){return e.aud instanceof Array?!!this.arrayHelperService.areEqual(e.aud,t)||(this.loggerService.logDebug("Validate_id_token_aud  array failed, dataIdToken.aud: "+e.aud+" client_id:"+t),!1):e.aud===t||(this.loggerService.logDebug("Validate_id_token_aud failed, dataIdToken.aud: "+e.aud+" client_id:"+t),!1)},e.prototype.validateStateFromHashCallback=function(e,t){return e===t||(this.loggerService.logDebug("ValidateStateFromHashCallback failed, state: "+e+" local_state:"+t),!1)},e.prototype.validate_userdata_sub_id_token=function(e,t){return e===t||(this.loggerService.logDebug("validate_userdata_sub_id_token failed, id_token_sub: "+e+" userdata_sub:"+t),!1)},e.prototype.validate_signature_id_token=function(e,t){var i,o,n,r,s,a;if(!t||!t.keys)return!1;var u=this.tokenHelperService.getHeaderFromToken(e,!1);if(0===Object.keys(u).length&&u.constructor===Object)return this.loggerService.logWarning("id token has no header data"),!1;var c=u.kid;if("RS256"!==u.alg)return this.loggerService.logWarning("Only RS256 supported"),!1;var l=!1;if(u.hasOwnProperty("kid"))try{for(var h=I(t.keys),d=h.next();!d.done;d=h.next()){if((S=d.value).kid===c){v=w.KEYUTIL.getKey(S);return(l=w.KJUR.jws.JWS.verify(e,v,["RS256"]))||this.loggerService.logWarning("incorrect Signature, validation failed for id_token"),l}}}catch(m){s={error:m}}finally{try{d&&!d.done&&(a=h["return"])&&a.call(h)}finally{if(s)throw s.error}}else{var g=0;try{for(var p=I(t.keys),f=p.next();!f.done;f=p.next()){"RSA"===(S=f.value).kty&&(g+=1)}}catch(b){i={error:b}}finally{try{f&&!f.done&&(o=p["return"])&&o.call(p)}finally{if(i)throw i.error}}if(0===g)return this.loggerService.logWarning("no keys found, incorrect Signature, validation failed for id_token"),!1;if(1<g)return this.loggerService.logWarning("no ID Token kid claim in JOSE header and multiple supplied in jwks_uri"),!1;try{for(var _=I(t.keys),y=_.next();!y.done;y=_.next()){var S;if("RSA"===(S=y.value).kty){var v=w.KEYUTIL.getKey(S);return(l=w.KJUR.jws.JWS.verify(e,v,["RS256"]))||this.loggerService.logWarning("incorrect Signature, validation failed for id_token"),l}}}catch(C){n={error:C}}finally{try{y&&!y.done&&(r=_["return"])&&r.call(_)}finally{if(n)throw n.error}}}return l},e.prototype.config_validate_response_type=function(e){return"id_token token"===e||"id_token"===e||("code"===e||(this.loggerService.logWarning("module configure incorrect, invalid response_type:"+e),!1))},e.prototype.validate_id_token_at_hash=function(e,t,i){if(this.loggerService.logDebug("at_hash from the server:"+t),i&&!t)return this.loggerService.logDebug("Code Flow active, and no at_hash in the id_token, skipping check!"),!0;var o=this.generate_at_hash(""+e);if(this.loggerService.logDebug("at_hash client validation not decoded:"+o),o===t)return!0;var n=this.generate_at_hash(""+decodeURIComponent(e));return this.loggerService.logDebug("-gen access--"+n),n===t},e.prototype.generate_at_hash=function(e){var t=w.KJUR.crypto.Util.hashString(e,"sha256"),i=t.substr(0,t.length/2);return w.hextob64u(i)},e.prototype.generate_code_verifier=function(e){var t=w.KJUR.crypto.Util.hashString(e,"sha256");return w.hextob64u(t)},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:v},{type:m},{type:y}]},e}(),E=function(){function e(e,t,i,o,n){this.authConfiguration=e,this.oidcSecurityCommon=t,this.oidcSecurityValidation=i,this.tokenHelperService=o,this.loggerService=n,this.authWellKnownEndpoints=new r}return e.prototype.setupModule=function(e){this.authWellKnownEndpoints=Object.assign({},e)},e.prototype.validateState=function(e,t){var i=new l;if(!this.oidcSecurityValidation.validateStateFromHashCallback(e.state,this.oidcSecurityCommon.authStateControl))return this.loggerService.logWarning("authorizedCallback incorrect state"),i.state=c.StatesDoNotMatch,i;if("id_token token"!==this.authConfiguration.response_type&&"code"!==this.authConfiguration.response_type||(i.access_token=e.access_token),i.id_token=e.id_token,i.decoded_id_token=this.tokenHelperService.getPayloadFromToken(i.id_token,!1),!this.oidcSecurityValidation.validate_signature_id_token(i.id_token,t))return this.loggerService.logDebug("authorizedCallback Signature validation failed id_token"),i.state=c.SignatureFailed,i;if(!this.oidcSecurityValidation.validate_id_token_nonce(i.decoded_id_token,this.oidcSecurityCommon.authNonce))return this.loggerService.logWarning("authorizedCallback incorrect nonce"),i.state=c.IncorrectNonce,i;if(!this.oidcSecurityValidation.validate_required_id_token(i.decoded_id_token))return this.loggerService.logDebug("authorizedCallback Validation, one of the REQUIRED properties missing from id_token"),i.state=c.RequiredPropertyMissing,i;if(!this.oidcSecurityValidation.validate_id_token_iat_max_offset(i.decoded_id_token,this.authConfiguration.max_id_token_iat_offset_allowed_in_seconds,this.authConfiguration.disable_iat_offset_validation))return this.loggerService.logWarning("authorizedCallback Validation, iat rejected id_token was issued too far away from the current time"),i.state=c.MaxOffsetExpired,i;if(!this.authWellKnownEndpoints)return this.loggerService.logWarning("authWellKnownEndpoints is undefined"),i.state=c.NoAuthWellKnownEndPoints,i;if(this.authConfiguration.iss_validation_off)this.loggerService.logDebug("iss validation is turned off, this is not recommended!");else if(!this.authConfiguration.iss_validation_off&&!this.oidcSecurityValidation.validate_id_token_iss(i.decoded_id_token,this.authWellKnownEndpoints.issuer))return this.loggerService.logWarning("authorizedCallback incorrect iss does not match authWellKnownEndpoints issuer"),i.state=c.IssDoesNotMatchIssuer,i;return this.oidcSecurityValidation.validate_id_token_aud(i.decoded_id_token,this.authConfiguration.client_id)?this.oidcSecurityValidation.validate_id_token_exp_not_expired(i.decoded_id_token)?"id_token token"!==this.authConfiguration.response_type&&"code"!==this.authConfiguration.response_type?(i.authResponseIsValid=!0,i.state=c.Ok,this.handleSuccessfulValidation()):this.oidcSecurityValidation.validate_id_token_at_hash(i.access_token,i.decoded_id_token.at_hash,"code"===this.authConfiguration.response_type)&&i.access_token?(i.authResponseIsValid=!0,i.state=c.Ok,this.handleSuccessfulValidation()):(this.loggerService.logWarning("authorizedCallback incorrect at_hash"),i.state=c.IncorrectAtHash):(this.loggerService.logWarning("authorizedCallback token expired"),i.state=c.TokenExpired):(this.loggerService.logWarning("authorizedCallback incorrect aud"),i.state=c.IncorrectAud),i},e.prototype.handleSuccessfulValidation=function(){this.oidcSecurityCommon.authNonce="",this.authConfiguration.auto_clean_state_after_authentication&&(this.oidcSecurityCommon.authStateControl=""),this.loggerService.logDebug("AuthorizedCallback token(s) validated, continue")},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:g},{type:k},{type:D},{type:m},{type:y}]},e}(),z="myiFrameForCheckSession",R=function(){function e(e,t,i,o,n){this.authConfiguration=e,this.oidcSecurityCommon=t,this.loggerService=i,this.iFrameService=o,this.zone=n,this.lastIFrameRefresh=0,this.outstandingMessages=0,this.heartBeatInterval=3e3,this.iframeRefreshInterval=6e4,this._onCheckSessionChanged=new p.Subject}return Object.defineProperty(e.prototype,"onCheckSessionChanged",{get:function(){return this._onCheckSessionChanged.asObservable()},enumerable:!0,configurable:!0}),e.prototype.setupModule=function(e){this.authWellKnownEndpoints=Object.assign({},e)},e.prototype.doesSessionExist=function(){var e=this.iFrameService.getExistingIFrame(z);return!!e&&(this.sessionIframe=e,!0)},e.prototype.init=function(){var t=this;return this.lastIFrameRefresh+this.iframeRefreshInterval>Date.now()?p.from([this]):(this.doesSessionExist()||(this.sessionIframe=this.iFrameService.addIFrameToWindowBody(z),this.iframeMessageEvent=this.messageHandler.bind(this),window.addEventListener("message",this.iframeMessageEvent,!1)),this.authWellKnownEndpoints?this.sessionIframe.contentWindow.location.replace(this.authWellKnownEndpoints.check_session_iframe):this.loggerService.logWarning("init check session: authWellKnownEndpoints is undefined"),p.Observable.create(function(e){t.sessionIframe.onload=function(){t.lastIFrameRefresh=Date.now(),e.next(t),e.complete()}}))},e.prototype.startCheckingSession=function(e){this.scheduledHeartBeat||this.pollServerSession(e)},e.prototype.stopCheckingSession=function(){this.scheduledHeartBeat&&this.clearScheduledHeartBeat()},e.prototype.pollServerSession=function(t){var i=this,o=function(){i.init().pipe(f.take(1)).subscribe(function(){if(i.sessionIframe&&t){i.loggerService.logDebug(i.sessionIframe);var e=i.oidcSecurityCommon.sessionState;e?(i.outstandingMessages++,i.sessionIframe.contentWindow.postMessage(t+" "+e,i.authConfiguration.stsServer)):(i.loggerService.logDebug("OidcSecurityCheckSession pollServerSession session_state is blank"),i._onCheckSessionChanged.next())}else i.loggerService.logWarning("OidcSecurityCheckSession pollServerSession sessionIframe does not exist"),i.loggerService.logDebug(t),i.loggerService.logDebug(i.sessionIframe);3<i.outstandingMessages&&(i.loggerService.logError("OidcSecurityCheckSession not receiving check session response messages. Outstanding messages: "+i.outstandingMessages+". Server unreachable?"),i._onCheckSessionChanged.next()),i.scheduledHeartBeat=setTimeout(o,i.heartBeatInterval)})};this.outstandingMessages=0,this.zone.runOutsideAngular(function(){i.scheduledHeartBeat=setTimeout(o,i.heartBeatInterval)})},e.prototype.clearScheduledHeartBeat=function(){clearTimeout(this.scheduledHeartBeat),this.scheduledHeartBeat=null},e.prototype.messageHandler=function(e){this.outstandingMessages=0,this.sessionIframe&&e.origin===this.authConfiguration.stsServer&&e.source===this.sessionIframe.contentWindow&&("error"===e.data?this.loggerService.logWarning("error from checksession messageHandler"):"changed"===e.data?this._onCheckSessionChanged.next():this.loggerService.logDebug(e.data+" from checksession messageHandler"))},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:g},{type:k},{type:y},{type:S},{type:o.NgZone}]},e}(),O=function(){function e(e){this.httpClient=e,this._onConfigurationLoaded=new p.Subject}return Object.defineProperty(e.prototype,"onConfigurationLoaded",{get:function(){return this._onConfigurationLoaded.asObservable()},enumerable:!0,configurable:!0}),e.prototype.load=function(t){var i=this;this.httpClient.get(t).pipe(f.map(function(e){i.clientConfiguration=e,i.load_using_stsServer(i.clientConfiguration.stsServer)}),f.catchError(function(e){return console.error("OidcConfigService 'load' threw an error on calling "+t,e),i._onConfigurationLoaded.next(!1),p.of(!1)})).subscribe()},e.prototype.load_using_stsServer=function(t){var i=this,e=t+"/.well-known/openid-configuration";this.httpClient.get(e).pipe(f.map(function(e){i.wellKnownEndpoints=e,i._onConfigurationLoaded.next(!0)}),f.catchError(function(e){return console.error("OidcConfigService 'load_using_stsServer' threw an error on calling "+t,e),i._onConfigurationLoaded.next(!1),p.of(!1)})).subscribe()},e.prototype.load_using_custom_stsServer=function(t){var i=this;this.httpClient.get(t).pipe(f.map(function(e){i.wellKnownEndpoints=e,i._onConfigurationLoaded.next(!0)}),f.catchError(function(e){return console.error("OidcConfigService 'load_using_custom_stsServer' threw an error on calling "+t,e),i._onConfigurationLoaded.next(!1),p.of(!1)})).subscribe()},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:h.HttpClient}]},e}(),A="myiFrameForSilentRenew",W=function(){function e(e,t){this.loggerService=e,this.iFrameService=t,this.isRenewInitialized=!1}return e.prototype.initRenew=function(){this.iFrameService.getExistingIFrame(A)||this.iFrameService.addIFrameToWindowBody(A),this.isRenewInitialized=!0},e.prototype.startRenew=function(e){var t=this;return this.isRenewInitialized||this.initRenew(),this.sessionIframe=this.iFrameService.getExistingIFrame(A),this.loggerService.logDebug("startRenew for URL:"+e),this.sessionIframe.contentWindow.location.replace(e),p.Observable.create(function(e){t.sessionIframe.onload=function(){e.next(t),e.complete()}})},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:y},{type:S}]},e}(),j=function(){function e(e,t,i){this.oidcDataService=e,this.oidcSecurityCommon=t,this.loggerService=i,this.userData=""}return e.prototype.setupModule=function(e){this.authWellKnownEndpoints=Object.assign({},e)},e.prototype.initUserData=function(){var t=this;return this.getIdentityUserData().pipe(f.map(function(e){return t.userData=e}))},e.prototype.getUserData=function(){if(!this.userData)throw Error("UserData is not set!");return this.userData},e.prototype.setUserData=function(e){this.userData=e},e.prototype.getIdentityUserData=function(){var e=this.oidcSecurityCommon.getAccessToken();if(!this.authWellKnownEndpoints)throw this.loggerService.logWarning("init check session: authWellKnownEndpoints is undefined"),Error("authWellKnownEndpoints is undefined");if(!(this.authWellKnownEndpoints&&this.authWellKnownEndpoints.userinfo_endpoint))throw this.loggerService.logError("init check session: authWellKnownEndpoints.userinfo_endpoint is undefined; set auto_userinfo = false in config"),Error("authWellKnownEndpoints.userinfo_endpoint is undefined");return this.oidcDataService.getIdentityUserData(this.authWellKnownEndpoints.userinfo_endpoint,e)},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:_},{type:k},{type:y}]},e}(),F=function(){function e(){}return e.prototype.encodeKey=function(e){return encodeURIComponent(e)},e.prototype.encodeValue=function(e){return encodeURIComponent(e)},e.prototype.decodeKey=function(e){return decodeURIComponent(e)},e.prototype.decodeValue=function(e){return decodeURIComponent(e)},e}(),P=function(){function e(e,t,i,o,n,r,s,a,u,c,l,h,d){var g=this;this.oidcDataService=e,this.stateValidationService=t,this.authConfiguration=i,this.router=o,this.oidcSecurityCheckSession=n,this.oidcSecuritySilentRenew=r,this.oidcSecurityUserService=s,this.oidcSecurityCommon=a,this.oidcSecurityValidation=u,this.tokenHelperService=c,this.loggerService=l,this.zone=h,this.httpClient=d,this._onModuleSetup=new p.Subject,this._onCheckSessionChanged=new p.Subject,this._onAuthorizationResult=new p.Subject,this.checkSessionChanged=!1,this.moduleSetup=!1,this._isModuleSetup=new p.BehaviorSubject(!1),this._isAuthorized=new p.BehaviorSubject(!1),this._userData=new p.BehaviorSubject(""),this.authWellKnownEndpointsLoaded=!1,this.runTokenValidationRunning=!1,this.onModuleSetup.pipe(f.take(1)).subscribe(function(){g.moduleSetup=!0,g._isModuleSetup.next(!0)}),this._isSetupAndAuthorized=this._isModuleSetup.pipe(f.filter(function(e){return e}),f.switchMap(function(){if(!g.authConfiguration.silent_renew)return p.from([!0]).pipe(f.tap(function(){return g.loggerService.logDebug("IsAuthorizedRace: Silent Renew Not Active. Emitting.")}));var e=g._isAuthorized.asObservable().pipe(f.filter(function(e){return e}),f.take(1),f.tap(function(){return g.loggerService.logDebug("IsAuthorizedRace: Existing token is still authorized.")}),f.race(g._onAuthorizationResult.pipe(f.take(1),f.tap(function(){return g.loggerService.logDebug("IsAuthorizedRace: Silent Renew Refresh Session Complete")}),f.map(function(){return!0})),p.timer(5e3).pipe(f.tap(function(){return g.loggerService.logWarning("IsAuthorizedRace: Timeout reached. Emitting.")}),f.map(function(){return!0}))));return g.loggerService.logDebug("Silent Renew is active, check if token in storage is active"),""!==g.oidcSecurityCommon.authNonce&&g.oidcSecurityCommon.authNonce!==undefined||(g.loggerService.logDebug("Silent Renew or login not running, try to refresh the session"),g.refreshSession()),e}),f.tap(function(){return g.loggerService.logDebug("IsAuthorizedRace: Completed")}),f.switchMapTo(this._isAuthorized.asObservable()),f.tap(function(e){return g.loggerService.logDebug("getIsAuthorized: "+e)}),f.shareReplay(1)),this._isSetupAndAuthorized.pipe(f.filter(function(){return g.authConfiguration.start_checksession})).subscribe(function(e){e?g.oidcSecurityCheckSession.startCheckingSession(g.authConfiguration.client_id):g.oidcSecurityCheckSession.stopCheckingSession()})}return Object.defineProperty(e.prototype,"onModuleSetup",{get:function(){return this._onModuleSetup.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onAuthorizationResult",{get:function(){return this._onAuthorizationResult.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onCheckSessionChanged",{get:function(){return this._onCheckSessionChanged.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onConfigurationChange",{get:function(){return this.authConfiguration.onConfigurationChange},enumerable:!0,configurable:!0}),e.prototype.setupModule=function(e,t){var i=this;this.authWellKnownEndpoints=Object.assign({},t),this.authConfiguration.init(e),this.stateValidationService.setupModule(t),this.oidcSecurityCheckSession.setupModule(t),this.oidcSecurityUserService.setupModule(t),this.oidcSecurityCheckSession.onCheckSessionChanged.subscribe(function(){i.loggerService.logDebug("onCheckSessionChanged"),i.checkSessionChanged=!0,i._onCheckSessionChanged.next(i.checkSessionChanged)});var o=this.oidcSecurityCommon.userData;o&&this.setUserData(o);var n=this.oidcSecurityCommon.isAuthorized;if(n&&(this.loggerService.logDebug("IsAuthorized setup module"),this.loggerService.logDebug(this.oidcSecurityCommon.idToken),this.oidcSecurityValidation.isTokenExpired(this.oidcSecurityCommon.idToken,this.authConfiguration.silent_renew_offset_in_seconds)?this.loggerService.logDebug("IsAuthorized setup module; id_token isTokenExpired"):(this.loggerService.logDebug("IsAuthorized setup module; id_token is valid"),this.setIsAuthorized(n)),this.runTokenValidation()),this.loggerService.logDebug("STS server: "+this.authConfiguration.stsServer),this._onModuleSetup.next(),this.authConfiguration.silent_renew){this.oidcSecuritySilentRenew.initRenew(),this.boundSilentRenewEvent=this.silentRenewEventHandler.bind(this);var r=Math.random(),s=function(e){e.detail!==r&&(window.removeEventListener("oidc-silent-renew-message",i.boundSilentRenewEvent),window.removeEventListener("oidc-silent-renew-init",s))}.bind(this);window.addEventListener("oidc-silent-renew-init",s,!1),window.addEventListener("oidc-silent-renew-message",this.boundSilentRenewEvent,!1),window.dispatchEvent(new CustomEvent("oidc-silent-renew-init",{detail:r}))}},e.prototype.getUserData=function(){return this._userData.asObservable()},e.prototype.getIsModuleSetup=function(){return this._isModuleSetup.asObservable()},e.prototype.getIsAuthorized=function(){return this._isSetupAndAuthorized},e.prototype.getToken=function(){if(!this._isAuthorized.getValue())return"";var e=this.oidcSecurityCommon.getAccessToken();return decodeURIComponent(e)},e.prototype.getIdToken=function(){if(!this._isAuthorized.getValue())return"";var e=this.oidcSecurityCommon.getIdToken();return decodeURIComponent(e)},e.prototype.getPayloadFromIdToken=function(e){void 0===e&&(e=!1);var t=this.getIdToken();return this.tokenHelperService.getPayloadFromToken(t,e)},e.prototype.setState=function(e){this.oidcSecurityCommon.authStateControl=e},e.prototype.getState=function(){return this.oidcSecurityCommon.authStateControl},e.prototype.setCustomRequestParameters=function(e){this.oidcSecurityCommon.customRequestParams=e},e.prototype.authorize=function(e){if(this.authWellKnownEndpoints&&(this.authWellKnownEndpointsLoaded=!0),this.authWellKnownEndpointsLoaded){if(this.oidcSecurityValidation.config_validate_response_type(this.authConfiguration.response_type)){this.resetAuthorizationData(!1),this.loggerService.logDebug("BEGIN Authorize Code Flow, no auth data");var t=this.oidcSecurityCommon.authStateControl;t||(t=Date.now()+""+Math.random()+Math.random(),this.oidcSecurityCommon.authStateControl=t);var i="N"+Math.random()+Date.now();this.oidcSecurityCommon.authNonce=i,this.loggerService.logDebug("AuthorizedController created. local state: "+this.oidcSecurityCommon.authStateControl);var o="";if("code"===this.authConfiguration.response_type){var n="C"+Math.random()+Date.now()+Date.now()+Math.random(),r=this.oidcSecurityValidation.generate_code_verifier(n);this.oidcSecurityCommon.code_verifier=n,this.authWellKnownEndpoints?o=this.createAuthorizeUrl(!0,r,this.authConfiguration.redirect_url,i,t,this.authWellKnownEndpoints.authorization_endpoint):this.loggerService.logError("authWellKnownEndpoints is undefined")}else this.authWellKnownEndpoints?o=this.createAuthorizeUrl(!1,"",this.authConfiguration.redirect_url,i,t,this.authWellKnownEndpoints.authorization_endpoint):this.loggerService.logError("authWellKnownEndpoints is undefined");e?e(o):this.redirectTo(o)}}else this.loggerService.logError("Well known endpoints must be loaded before user can login!")},e.prototype.authorizedCallbackWithCode=function(e){var t=e.split("?"),i=new h.HttpParams({fromString:t[1]}),o=i.get("code"),n=i.get("state"),r=i.get("session_state");o&&n&&this.requestTokensWithCode(o,n,r)},e.prototype.requestTokensWithCode=function(e,t,i){var o=this;this._isModuleSetup.pipe(f.filter(function(e){return e}),f.take(1)).subscribe(function(){o.requestTokensWithCodeProcedure(e,t,i)})},e.prototype.requestTokensWithCodeProcedure=function(e,i,o){var n=this,t="";if(this.authWellKnownEndpoints&&this.authWellKnownEndpoints.token_endpoint&&(t=""+this.authWellKnownEndpoints.token_endpoint),this.oidcSecurityValidation.validateStateFromHashCallback(i,this.oidcSecurityCommon.authStateControl)){var r=new h.HttpHeaders;r=r.set("Content-Type","application/x-www-form-urlencoded");var s="grant_type=authorization_code&client_id="+this.authConfiguration.client_id+"&code_verifier="+this.oidcSecurityCommon.code_verifier+"&code="+e+"&redirect_uri="+this.authConfiguration.redirect_url;"running"===this.oidcSecurityCommon.silentRenewRunning&&(s="grant_type=authorization_code&client_id="+this.authConfiguration.client_id+"&code_verifier="+this.oidcSecurityCommon.code_verifier+"&code="+e+"&redirect_uri="+this.authConfiguration.silent_redirect_url),this.httpClient.post(t,s,{headers:r}).pipe(f.map(function(e){var t=new Object;(t=e).state=i,t.session_state=o,n.authorizedCodeFlowCallbackProcedure(t)}),f.catchError(function(e){return n.loggerService.logError(e),n.loggerService.logError("OidcService code request "+n.authConfiguration.stsServer),p.of(!1)})).subscribe()}else this.loggerService.logWarning("authorizedCallback incorrect state")},e.prototype.authorizedCodeFlowCallbackProcedure=function(e){var t="running"===this.oidcSecurityCommon.silentRenewRunning;this.loggerService.logDebug("BEGIN authorized Code Flow Callback, no auth data"),this.resetAuthorizationData(t),this.authorizedCallbackProcedure(e,t)},e.prototype.authorizedImplicitFlowCallbackProcedure=function(e){var t="running"===this.oidcSecurityCommon.silentRenewRunning;this.loggerService.logDebug("BEGIN authorizedCallback, no auth data"),this.resetAuthorizationData(t);var i=(e=e||window.location.hash.substr(1)).split("&").reduce(function(e,t){var i=t.split("=");return e[i.shift()]=i.join("="),e},{});this.authorizedCallbackProcedure(i,t)},e.prototype.authorizedImplicitFlowCallback=function(e){var t=this;this._isModuleSetup.pipe(f.filter(function(e){return e}),f.take(1)).subscribe(function(){t.authorizedImplicitFlowCallbackProcedure(e)})},e.prototype.redirectTo=function(e){window.location.href=e},e.prototype.authorizedCallbackProcedure=function(i,o){var n=this;this.oidcSecurityCommon.authResult=i,this.authConfiguration.history_cleanup_off||o?this.loggerService.logDebug("history clean up inactive"):window.history.replaceState({},window.document.title,window.location.origin+window.location.pathname),i.error?(this.loggerService.logWarning(i),"login_required"===i.error?this._onAuthorizationResult.next(new s(a.unauthorized,c.LoginRequired)):this._onAuthorizationResult.next(new s(a.unauthorized,c.SecureTokenServerError)),this.authConfiguration.trigger_authorization_result_event||o||this.router.navigate([this.authConfiguration.unauthorized_route])):(this.loggerService.logDebug(i),this.loggerService.logDebug("authorizedCallback created, begin token validation"),this.getSigningKeys().subscribe(function(e){var t=n.getValidatedStateResult(i,e);t.authResponseIsValid?(n.setAuthorizationData(t.access_token,t.id_token),n.oidcSecurityCommon.silentRenewRunning="",n.authConfiguration.auto_userinfo?n.getUserinfo(o,i,t.id_token,t.decoded_id_token).subscribe(function(e){e?(n._onAuthorizationResult.next(new s(a.authorized,t.state)),n.authConfiguration.trigger_authorization_result_event||o||n.router.navigate([n.authConfiguration.post_login_route])):(n._onAuthorizationResult.next(new s(a.unauthorized,t.state)),n.authConfiguration.trigger_authorization_result_event||o||n.router.navigate([n.authConfiguration.unauthorized_route]))},function(e){n.loggerService.logWarning("Failed to retreive user info with error: "+JSON.stringify(e))}):(o||(n.oidcSecurityUserService.setUserData(t.decoded_id_token),n.setUserData(n.oidcSecurityUserService.getUserData())),n.runTokenValidation(),n._onAuthorizationResult.next(new s(a.authorized,t.state)),n.authConfiguration.trigger_authorization_result_event||o||n.router.navigate([n.authConfiguration.post_login_route]))):(n.loggerService.logWarning("authorizedCallback, token(s) validation failed, resetting"),n.loggerService.logWarning(window.location.hash),n.resetAuthorizationData(!1),n.oidcSecurityCommon.silentRenewRunning="",n._onAuthorizationResult.next(new s(a.unauthorized,t.state)),n.authConfiguration.trigger_authorization_result_event||o||n.router.navigate([n.authConfiguration.unauthorized_route]))},function(e){n.loggerService.logWarning("Failed to retreive siging key with error: "+JSON.stringify(e)),n.oidcSecurityCommon.silentRenewRunning=""}))},e.prototype.getUserinfo=function(e,i,t,o){var n=this;return void 0===e&&(e=!1),i=i||this.oidcSecurityCommon.authResult,t=t||this.oidcSecurityCommon.idToken,o=o||this.tokenHelperService.getPayloadFromToken(t,!1),new p.Observable(function(t){"id_token token"===n.authConfiguration.response_type||"code"===n.authConfiguration.response_type?e&&n._userData.value?(n.oidcSecurityCommon.sessionState=i.session_state,t.next(!0),t.complete()):n.oidcSecurityUserService.initUserData().subscribe(function(){n.loggerService.logDebug("authorizedCallback (id_token token || code) flow");var e=n.oidcSecurityUserService.getUserData();n.oidcSecurityValidation.validate_userdata_sub_id_token(o.sub,e.sub)?(n.setUserData(e),n.loggerService.logDebug(n.oidcSecurityCommon.accessToken),n.loggerService.logDebug(n.oidcSecurityUserService.getUserData()),n.oidcSecurityCommon.sessionState=i.session_state,n.runTokenValidation(),t.next(!0)):(n.loggerService.logWarning("authorizedCallback, User data sub does not match sub in id_token"),n.loggerService.logDebug("authorizedCallback, token(s) validation failed, resetting"),n.resetAuthorizationData(!1),t.next(!1)),t.complete()}):(n.loggerService.logDebug("authorizedCallback id_token flow"),n.loggerService.logDebug(n.oidcSecurityCommon.accessToken),n.oidcSecurityUserService.setUserData(o),n.setUserData(n.oidcSecurityUserService.getUserData()),n.oidcSecurityCommon.sessionState=i.session_state,n.runTokenValidation(),t.next(!0),t.complete())})},e.prototype.logoff=function(e){if(this.loggerService.logDebug("BEGIN Authorize, no auth data"),this.authWellKnownEndpoints)if(this.authWellKnownEndpoints.end_session_endpoint){var t=this.authWellKnownEndpoints.end_session_endpoint,i=this.oidcSecurityCommon.idToken,o=this.createEndSessionUrl(t,i);this.resetAuthorizationData(!1),this.authConfiguration.start_checksession&&this.checkSessionChanged?this.loggerService.logDebug("only local login cleaned up, server session has changed"):e?e(o):this.redirectTo(o)}else this.resetAuthorizationData(!1),this.loggerService.logDebug("only local login cleaned up, no end_session_endpoint");else this.loggerService.logWarning("authWellKnownEndpoints is undefined")},e.prototype.refreshSession=function(){if(!this.authConfiguration.silent_renew)return p.from([!1]);this.loggerService.logDebug("BEGIN refresh session Authorize");var e=this.oidcSecurityCommon.authStateControl;""!==e&&null!==e||(e=Date.now()+""+Math.random()+Math.random(),this.oidcSecurityCommon.authStateControl=e);var t="N"+Math.random()+Date.now();this.oidcSecurityCommon.authNonce=t,this.loggerService.logDebug("RefreshSession created. adding myautostate: "+this.oidcSecurityCommon.authStateControl);var i="";if("code"===this.authConfiguration.response_type){var o="C"+Math.random()+Date.now()+Date.now()+Math.random(),n=this.oidcSecurityValidation.generate_code_verifier(o);this.oidcSecurityCommon.code_verifier=o,this.authWellKnownEndpoints?i=this.createAuthorizeUrl(!0,n,this.authConfiguration.silent_redirect_url,t,e,this.authWellKnownEndpoints.authorization_endpoint,"none"):this.loggerService.logWarning("authWellKnownEndpoints is undefined")}else this.authWellKnownEndpoints?i=this.createAuthorizeUrl(!1,"",this.authConfiguration.silent_redirect_url,t,e,this.authWellKnownEndpoints.authorization_endpoint,"none"):this.loggerService.logWarning("authWellKnownEndpoints is undefined");return this.oidcSecurityCommon.silentRenewRunning="running",this.oidcSecuritySilentRenew.startRenew(i)},e.prototype.handleError=function(e){if(this.loggerService.logError(e),403===e.status||"403"===e.status)this.authConfiguration.trigger_authorization_result_event?this._onAuthorizationResult.next(new s(a.unauthorized,c.NotSet)):this.router.navigate([this.authConfiguration.forbidden_route]);else if(401===e.status||"401"===e.status){var t=this.oidcSecurityCommon.silentRenewRunning;this.resetAuthorizationData(!!t),this.authConfiguration.trigger_authorization_result_event?this._onAuthorizationResult.next(new s(a.unauthorized,c.NotSet)):this.router.navigate([this.authConfiguration.unauthorized_route])}},e.prototype.startCheckingSilentRenew=function(){this.runTokenValidation()},e.prototype.stopCheckingSilentRenew=function(){this._scheduledHeartBeat&&(clearTimeout(this._scheduledHeartBeat),this._scheduledHeartBeat=null,this.runTokenValidationRunning=!1)},e.prototype.resetAuthorizationData=function(e){e||(this.authConfiguration.auto_userinfo&&this.setUserData(""),this.oidcSecurityCommon.resetStorageData(e),this.checkSessionChanged=!1,this.setIsAuthorized(!1))},e.prototype.getEndSessionUrl=function(){if(this.authWellKnownEndpoints&&this.authWellKnownEndpoints.end_session_endpoint){var e=this.authWellKnownEndpoints.end_session_endpoint,t=this.oidcSecurityCommon.idToken;return this.createEndSessionUrl(e,t)}},e.prototype.getValidatedStateResult=function(e,t){return e.error?new l("","",!1,{}):this.stateValidationService.validateState(e,t)},e.prototype.setUserData=function(e){this.oidcSecurityCommon.userData=e,this._userData.next(e)},e.prototype.setIsAuthorized=function(e){this._isAuthorized.next(e)},e.prototype.setAuthorizationData=function(e,t){""!==this.oidcSecurityCommon.accessToken&&(this.oidcSecurityCommon.accessToken=""),this.loggerService.logDebug(e),this.loggerService.logDebug(t),this.loggerService.logDebug("storing to storage, getting the roles"),this.oidcSecurityCommon.accessToken=e,this.oidcSecurityCommon.idToken=t,this.setIsAuthorized(!0),this.oidcSecurityCommon.isAuthorized=!0},e.prototype.createAuthorizeUrl=function(e,t,i,o,n,r,s){var a=r.split("?"),u=a[0],c=new h.HttpParams({fromString:a[1],encoder:new F});c=(c=(c=(c=(c=(c=c.set("client_id",this.authConfiguration.client_id)).append("redirect_uri",i)).append("response_type",this.authConfiguration.response_type)).append("scope",this.authConfiguration.scope)).append("nonce",o)).append("state",n),e&&(c=(c=c.append("code_challenge",t)).append("code_challenge_method","S256")),s&&(c=c.append("prompt",s)),this.authConfiguration.hd_param&&(c=c.append("hd",this.authConfiguration.hd_param));var l=Object.assign({},this.oidcSecurityCommon.customRequestParams);return Object.keys(l).forEach(function(e){c=c.append(e,l[e].toString())}),u+"?"+c},e.prototype.createEndSessionUrl=function(e,t){var i=e.split("?"),o=i[0],n=new h.HttpParams({fromString:i[1],encoder:new F});return o+"?"+(n=(n=n.set("id_token_hint",t)).append("post_logout_redirect_uri",this.authConfiguration.post_logout_redirect_uri))},e.prototype.getSigningKeys=function(){return this.authWellKnownEndpoints?(this.loggerService.logDebug("jwks_uri: "+this.authWellKnownEndpoints.jwks_uri),this.oidcDataService.get(this.authWellKnownEndpoints.jwks_uri).pipe(f.catchError(this.handleErrorGetSigningKeys))):(this.loggerService.logWarning("getSigningKeys: authWellKnownEndpoints is undefined"),this.oidcDataService.get("undefined").pipe(f.catchError(this.handleErrorGetSigningKeys)))},e.prototype.handleErrorGetSigningKeys=function(e){var t;if(e instanceof Response){var i=e.json()||{},o=JSON.stringify(i);t=e.status+" - "+(e.statusText||"")+" "+o}else t=e.message?e.message:e.toString();return console.error(t),p.throwError(t)},e.prototype.runTokenValidation=function(){var t=this;if(!this.runTokenValidationRunning&&this.authConfiguration.silent_renew){this.runTokenValidationRunning=!0,this.loggerService.logDebug("runTokenValidation silent-renew running");var i=function(){if(t.loggerService.logDebug("silentRenewHeartBeatCheck\r\n\tsilentRenewRunning: "+("running"===t.oidcSecurityCommon.silentRenewRunning)+"\r\n\tidToken: "+!!t.getIdToken()+"\r\n\t_userData.value: "+!!t._userData.value),t._userData.value&&"running"!==t.oidcSecurityCommon.silentRenewRunning&&t.getIdToken()&&t.oidcSecurityValidation.isTokenExpired(t.oidcSecurityCommon.idToken,t.authConfiguration.silent_renew_offset_in_seconds)){if(t.loggerService.logDebug("IsAuthorized: id_token isTokenExpired, start silent renew if active"),t.authConfiguration.silent_renew)return void t.refreshSession().subscribe(function(){t._scheduledHeartBeat=setTimeout(i,3e3)},function(e){t.loggerService.logError("Error: "+e),t._scheduledHeartBeat=setTimeout(i,3e3)});t.resetAuthorizationData(!1)}t._scheduledHeartBeat=setTimeout(i,3e3)};this.zone.runOutsideAngular(function(){t._scheduledHeartBeat=setTimeout(i,1e4)})}},e.prototype.silentRenewEventHandler=function(e){if(this.loggerService.logDebug("silentRenewEventHandler"),"code"===this.authConfiguration.response_type){var t=e.detail.toString().split("?"),i=new h.HttpParams({fromString:t[1]}),o=i.get("code"),n=i.get("state"),r=i.get("session_state"),s=i.get("error");o&&n&&this.requestTokensWithCodeProcedure(o,n,r),s&&this.loggerService.logDebug(e.detail.toString())}else this.authorizedImplicitFlowCallback(e.detail)},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:_},{type:E},{type:g},{type:i.Router},{type:R},{type:W},{type:j},{type:k},{type:D},{type:m},{type:y},{type:o.NgZone},{type:h.HttpClient}]},e}(),T=function(){function t(){}return t.forRoot=function(e){return void 0===e&&(e={}),{ngModule:t,providers:[O,P,D,R,W,j,k,g,m,y,S,v,r,_,E,{provide:b,useClass:e.storage||C}]}},t.decorators=[{type:o.NgModule}],t}();e.AuthWellKnownEndpoints=r,e.AuthorizationResult=s,e.AuthorizationState=a,e.JwtKeys=n,e.JwtKey=u,e.ValidateStateResult=l,e.ValidationResult=c,e.OpenIDImplicitFlowConfiguration=d,e.AuthConfiguration=g,e.AuthModule=T,e.OidcConfigService=O,e.OidcSecurityService=P,e.OidcSecurityStorage=b,e.BrowserStorage=C,e.OidcSecurityValidation=D,e.TokenHelperService=m,e.ɵa=_,e.ɵg=S,e.ɵd=v,e.ɵb=E,e.ɵe=y,e.ɵf=R,e.ɵc=k,e.ɵh=W,e.ɵi=j,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=angular-auth-oidc-client.umd.min.js.map